AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  Name:
    Type: String
    Description: name of the server
  KeyName:
    Description: https://us-east-1.console.aws.amazon.com/ec2/v2/home?region=us-east-1#KeyPairs
    Type: AWS::EC2::KeyPair::KeyName
    Default: ssh
  InstanceType:
    Description: https://aws.amazon.com/ec2/instance-types/
    Type: String
    Default: t3.micro
  SSHLocation:
    Description: curl ifconfig.me
    Type: String
    Default: 24.188.109.78/32
  AMI:
    Type: AWS::EC2::Image::Id
    Description: latest free x86 64 bit ubuntu AMI from Canonical - https://aws.amazon.com/marketplace/search
    Default: ami-05fce43d35a2bb540
  Subnet:
    Type: AWS::EC2::Subnet::Id
    Description: us-east-1c
    Default: subnet-08bcb7e889b485874
  AMIDeviceMount:
    Type: String
    Description: aws ec2 describe-images --query "Images[0].RootDeviceName" --image-ids ami-XXXXXXXXXX
    Default: /dev/sda1

Resources:
  # docs: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-security-group.html
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: general ec2 security group
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "22"
          ToPort: "22"
          CidrIp: !Ref "SSHLocation"
      Tags:
        - Key: Name
          Value: !Ref Name

  # docs: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-instance.html
  Instance:
    Type: AWS::EC2::Instance
    Properties:
      IamInstanceProfile: game-server
      InstanceType: !Ref InstanceType
      PropagateTagsToVolumeOnCreation: True
      SecurityGroupIds:
        - !GetAtt SecurityGroup.GroupId
      KeyName: !Ref KeyName
      ImageId: !Ref AMI
      SubnetId: !Ref Subnet
      Tags:
        - Key: Name
          Value: !Ref Name

  # docs: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-ebs-volume.html
  Volume:
    Type: AWS::EC2::Volume
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      Size: 10
      AvailabilityZone: !GetAtt Instance.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Ref Name

  # # docs: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-ec2-ebs-volumeattachment.html
  # VolumeAttachment:
  #   Type: AWS::EC2::VolumeAttachment
  #   Properties:
  #     InstanceId: !Ref Instance
  #     VolumeId: !Ref Volume
  #     Device: !Ref AMIDeviceMount

  # docs: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ssm-parameter.html
  PublicIp:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /cfn/public-ip
      Type: String
      Value: !GetAtt Instance.PublicIp

Outputs:
  PublicIp:
    Value: !GetAtt Instance.PublicIp
